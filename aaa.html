<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>مدل سه‌بعدی با مدیریت پیشرفته پس‌زمینه</title>

<!-- نسخه مدرن (برای مرورگرهای سازگار با ES Modules) -->
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<!-- نسخه لیگاسی (برای مرورگرهای قدیمی) -->
<script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    body {
      margin: 0;
      background-color: #f8f8f8;
      direction: rtl;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .container {
      width: 100%;
      max-width: 854px;
      aspect-ratio: 854 / 480;
      position: relative;
    }

    model-viewer {
      width: 100%;
      height: 100%;
      background-color: #fff;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    #progress-slider {
      position: absolute;
      bottom: 64px;
      left: 0;
      right: 0;
      margin: 0 20px;
      height: 6px;
      appearance: none;
      background: #ccc;
      border-radius: 4px;
      z-index: 9;
      accent-color: #007bff;
      direction: ltr;
      transition: opacity 0.5s ease;
      opacity: 1;
    }

    #progress-slider.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .control-buttons {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 10;
      transition: opacity 0.5s ease;
      opacity: 1;
    }

    .control-buttons.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .animation-controls.hidden {
      display: none !important;
    }

    .icon-button {
      width: 48px;
      height: 48px;
      background-color: transparent;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    .icon-button:hover {
      background-color: rgba(0, 123, 255, 0.1);
      box-shadow: 0 4px 10px rgba(0, 123, 255, 0.2);
    }

    .icon-button svg {
      width: 24px;
      height: 24px;
      fill: #aaaaaa;
    }

    .overlay {
      position: absolute;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.7);
      color: #fff;
      display: none;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start;
      padding: 30px;
      font-size: 18px;
      text-align: right;
      z-index: 20;
      border-radius: 8px;
      overflow-y: auto;
    }

    .overlay h2 {
      width: 100%;
      text-align: center;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .overlay p {
      margin: 8px 0;
      line-height: 1.8;
    }

    .extra-guide {
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.3);
    }

    .extra-guide p {
      font-size: 16px;
      line-height: 2;
    }

    .close-button {
      position: absolute;
      top: 12px;
      left: 12px;
      background: transparent;
      border: none;
      color: white;
      font-size: 26px;
      cursor: pointer;
    }

    #loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      flex-direction: column;
      gap: 16px;
      border-radius: 8px;
    }

    .loader-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* استایل‌های پنل پس‌زمینه */
    #backgroundPanel {
      justify-content: flex-start;
      padding-top: 60px;
    }

    #backgroundPanel h3 {
      margin-bottom: 10px;
      font-size: 18px;
      color: #eee;
    }

    #backgroundPanel label {
      color: #eee;
      margin-left: 10px;
    }

    #backgroundPanel input[type="color"] {
      width: 50px;
      height: 30px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }

    #backgroundPanel button:not(.close-button) {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin-top: 10px;
    }

    #backgroundPanel button:not(.close-button):hover {
      background: #0056b3;
    }

    .color-option {
      width: 40px;
      height: 40px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      margin: 15px 0;
    }

    .checkbox-container input {
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 600px) {
      .container {
        width: 95%;
        aspect-ratio: 16 / 9;
      }

      .overlay {
        font-size: 16px;
        padding: 20px;
      }

      .extra-guide p {
        font-size: 15px;
      }
      
      .control-buttons {
        bottom: 10px;
      }
      
      .icon-button {
        width: 42px;
        height: 42px;
      }
    }
  </style>
</head>
<body>

  <div class="container" id="model-container">
    <div id="loader">
      <div class="loader-spinner"></div>
      <p>در حال بارگذاری مدل...</p>
    </div>

    <model-viewer 
      id="viewer"
      src="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/refs/heads/main/2.0/Duck/glTF-Binary/Duck.glb" 
	  
      ios-src=".usdz"
      alt="مدل سه‌بعدی"
      auto-rotate 
      camera-controls
      shadow-intensity="1"
      exposure="1"
      autoplay
      ar
      ar-modes="webxr scene-viewer quick-look"
      vr
      xr-environment
      ar-scale="auto"
    >
      <button slot="ar-button" style="background-color: #fff; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="#007bff">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7z"/>
        </svg>
        نمایش در واقعیت افزوده
      </button>
    </model-viewer>

    <input type="range" id="progress-slider" min="0" max="100" value="0" class="animation-controls" />

    <div class="control-buttons" id="controls">
      <button class="icon-button animation-controls" id="animationToggle" title="توقف انیمیشن">
        <svg id="playIcon" viewBox="0 0 24 24" style="display: none;"><path d="M8 5v14l11-7z"/></svg>
        <svg id="pauseIcon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
      </button>

      <button class="icon-button" id="rotateToggle" title="توقف چرخش خودکار">
        <svg id="rotateOnIcon" viewBox="0 0 24 24"><path d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/></svg>
        <svg id="rotateOffIcon" viewBox="0 0 24 24" style="display: none;"><path d="M12 7.77L18.39 18H5.61L12 7.77M12 4L2 20h20L12 4z"/></svg>
      </button>

      <button class="icon-button" onclick="enterVR()" title="واقعیت مجازی">
        <svg viewBox="0 0 24 24"><path d="M21 4H3c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h5l2.5-3h3L16 18h5c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM3 16V6h18v10h-4.25l-2.25-3h-5L7.25 16H3z"/></svg>
      </button>

      <button class="icon-button" onclick="toggleFullscreen()" title="تمام‌صفحه">
        <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm0-4h2V7h3V5H7v5zm10 4h2v5h-5v-2h3v-3zm-2-9v2h3v3h2V5h-5z"/></svg>
      </button>

      <button class="icon-button" onclick="openBackgroundPanel()" title="تغییر پس‌زمینه">
        <svg viewBox="0 0 24 24"><path d="M12 22C6.49 22 2 17.51 2 12S6.49 2 12 2s10 4.49 10 10-4.49 10-10 10zm0-18c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm0 14c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/></svg>
      </button>

      <button class="icon-button" onclick="toggleHelp()" title="راهنما">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10
        10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm1.07-7.75-.9.92C12.45 13.9 12 14.5
        12 16h-2v-.5c0-1 .45-1.8 1.17-2.5l1.24-1.26c.37-.36.59-.86.59-1.41
        0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4
        4c0 .88-.36 1.68-.93 2.25z"/></svg>
      </button>
    </div>

    <div id="helpOverlay" class="overlay">
      <button class="close-button" onclick="toggleHelp()">×</button>
      <h2>راهنمای استفاده</h2>
      <p>🔄 <strong>چرخش مدل:</strong> کلیک چپ و کشیدن، یا کشیدن با یک انگشت روی موبایل</p>
      <p>🔍 <strong>بزرگنمایی:</strong>  اسکرول ماوس یا نیشگون (Pinch)</p>
      <p>↔️ <strong>جابجایی:</strong> کلیک راست و کشیدن، یا دو انگشت روی موبایل</p>
      <p>▶️ <strong>کنترل انیمیشن:</strong> استفاده از دکمه شروع/توقف برای کنترل انیمیشن مدل</p>
      <p>🔄 <strong>چرخش خودکار:</strong> دکمه کنترل چرخش خودکار برای فعال/غیرفعال کردن چرخش مدل</p>
      <div class="extra-guide">
        <p>🎮 <strong>راهنمای کامل تعامل با مدل:</strong></p>
        <p>🔁 <strong>چرخش دوربین:</strong> کشیدن یک انگشت (لمسی) یا کلیک چپ ماوس و حرکت</p>
        <p>↔️ <strong>جابجایی:</strong> کشیدن دو انگشت یا کلیک راست ماوس و حرکت</p>
        <p>🔎 <strong>کوچک‌نمایی:</strong> دوبار ضربه روی پس‌زمینه یا دوبار کلیک</p>
        <p>🔄 <strong>زوم:</strong> چرخ غلتک یا نیشگون</p>
        <p>⏯️ <strong>انیمیشن:</strong> دکمه کنترل انیمیشن پایین</p>
        <p>🎨 <strong>تغییر پس‌زمینه:</strong> استفاده از دکمه تغییر پس‌زمینه برای انتخاب رنگ یا تصویر دلخواه</p>
        <p>🔄 <strong>چرخش خودکار:</strong> دکمه چرخش خودکار برای متوقف کردن یا شروع چرخش مدل</p>
        <p>💾 <strong>ذخیره تنظیمات:</strong> تنظیمات پس‌زمینه برای هر مدل به صورت جداگانه ذخیره می‌شود</p>
      </div>
    </div>

    <div id="backgroundPanel" class="overlay" style="display: none;">
      <button class="close-button" onclick="closeBackgroundPanel()">×</button>
      <h2>تنظیمات پس‌زمینه</h2>
      
      <div style="margin: 20px 0;">
        <h3>رنگ پس‌زمینه:</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
          <button onclick="setBackgroundColor('#ffffff')" class="color-option" style="background: #ffffff;" title="سفید"></button>
          <button onclick="setBackgroundColor('#f8f8f8')" class="color-option" style="background: #f8f8f8;" title="خاکستری روشن"></button>
          <button onclick="setBackgroundColor('#000000')" class="color-option" style="background: #000000;" title="مشکی"></button>
          <button onclick="setBackgroundColor('#1e88e5')" class="color-option" style="background: #1e88e5;" title="آبی"></button>
          <button onclick="setBackgroundColor('#e53935')" class="color-option" style="background: #e53935;" title="قرمز"></button>
          <button onclick="setBackgroundColor('#43a047')" class="color-option" style="background: #43a047;" title="سبز"></button>
          <button onclick="setBackgroundColor('#ffeb3b')" class="color-option" style="background: #ffeb3b;" title="زرد"></button>
          <button onclick="setBackgroundColor('#7b1fa2')" class="color-option" style="background: #7b1fa2;" title="بنفش"></button>
        </div>
        <div style="margin-top: 15px;">
          <label for="customColor">رنگ سفارشی:</label>
          <input type="color" id="customColor" onchange="setCustomBackgroundColor(this.value)" style="margin-right: 10px;">
        </div>
      </div>
      
      <div style="margin: 20px 0;">
        <h3>تصویر پس‌زمینه:</h3>
        <input type="file" id="bgImageUpload" accept="image/*" style="display: none;" onchange="handleBackgroundImageUpload(this.files)">
        <button onclick="document.getElementById('bgImageUpload').click()" style="background: #b0b0b0; border: 1px dashed #ccc; padding: 10px 15px; border-radius: 4px; cursor: pointer;">
          انتخاب تصویر
        </button>
        <button onclick="removeBackgroundImage()" style="background: #b0b0b0; border: 1px solid #ccc; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px;">
          حذف تصویر
        </button>
        <p style="font-size: 14px; color: #ccc; margin-top: 10px;">توجه: تصاویر با نسبت 16:9 نتیجه بهتری دارند.</p>
      </div>

      <button onclick="saveBackgroundSettings()" style="background: #4CAF50; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin-top: 20px;">
        ذخیره تنظیمات برای این مدل
      </button>
    </div>
  </div>

  <script>
    const viewer = document.getElementById('viewer');
    const animationToggle = document.getElementById('animationToggle');
    const rotateToggle = document.getElementById('rotateToggle');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    const rotateOnIcon = document.getElementById('rotateOnIcon');
    const rotateOffIcon = document.getElementById('rotateOffIcon');
    const slider = document.getElementById('progress-slider');
    const loader = document.getElementById('loader');
    const controls = document.getElementById('controls');
    const container = document.getElementById('model-container');
    const animationControls = document.querySelectorAll('.animation-controls');
    
    let isPlaying = true;
    let isAutoRotating = true;
    let wasPlayingBeforeDrag = false;
    let isDragging = false;
    let rafId = null;
    let hideTimeout;
    let currentModelSettings = {
      color: '#ffffff',
      image: ''
    };
    let currentModelId = '';
    let hasAnimations = false;

    // تنظیم حالت اولیه آیکون‌ها
    pauseIcon.style.display = 'block';
    playIcon.style.display = 'none';
    rotateOnIcon.style.display = 'block';
    rotateOffIcon.style.display = 'none';

    // تولید شناسه منحصر به فرد برای مدل بر اساس آدرس فایل
    function getModelId() {
      const modelSrc = viewer.getAttribute('src');
      return modelSrc ? modelSrc : 'default-model';
    }

    // بارگذاری تنظیمات پس‌زمینه از localStorage برای مدل فعلی
    function loadBackgroundSettings() {
      currentModelId = getModelId();
      const savedSettings = localStorage.getItem(`modelViewerBackground_${currentModelId}`);
      
      if (savedSettings) {
        currentModelSettings = JSON.parse(savedSettings);
        
        if (currentModelSettings.image) {
          viewer.style.backgroundImage = `url(${currentModelSettings.image})`;
          viewer.style.backgroundSize = 'cover';
          viewer.style.backgroundColor = '';
        } else {
          viewer.style.backgroundColor = currentModelSettings.color;
          viewer.style.backgroundImage = 'none';
        }
      } else {
        // اگر تنظیماتی ذخیره نشده، از پیش‌فرض استفاده می‌کنیم
        resetToDefaultBackground();
      }
    }

    // ذخیره تنظیمات پس‌زمینه در localStorage برای مدل فعلی
    function saveBackgroundSettings() {
      currentModelId = getModelId();
      localStorage.setItem(`modelViewerBackground_${currentModelId}`, JSON.stringify(currentModelSettings));
      closeBackgroundPanel();
    }

    // بازنشانی به تنظیمات پیش‌فرض
    function resetToDefaultBackground() {
      viewer.style.backgroundColor = '#ffffff';
      viewer.style.backgroundImage = '';
      currentModelSettings = {
        color: '#ffffff',
        image: ''
      };
    }

    // بررسی وجود انیمیشن در مدل
    function checkForAnimations() {
      return new Promise((resolve) => {
        if (viewer.availableAnimations && viewer.availableAnimations.length > 0) {
          resolve(true);
        } else {
          // بررسی اضافی برای مدل‌هایی که ممکن است انیمیشن داشته باشند اما لیست نشده‌اند
          setTimeout(() => {
            const hasDuration = viewer.duration > 0;
            resolve(hasDuration);
          }, 500);
        }
      });
    }

    // تنظیم نمایش کنترل‌های انیمیشن بر اساس وجود انیمیشن
    function setupAnimationControls(hasAnim) {
      hasAnimations = hasAnim;
      
      if (hasAnimations) {
        // نمایش کنترل‌های انیمیشن
        animationControls.forEach(control => {
          control.classList.remove('hidden');
        });
        
        if (isPlaying) {
          startAnimationLoop();
        }
      } else {
        // مخفی کردن کنترل‌های انیمیشن
        animationControls.forEach(control => {
          control.classList.add('hidden');
        });
        
        // توقف هرگونه انیمیشن فعال
        stopAnimationLoop();
      }
    }

    // بهبود دکمه AR
    viewer.addEventListener('load', async () => {
      loader.style.display = 'none';
      
      // بررسی وجود انیمیشن
      const hasAnim = await checkForAnimations();
      setupAnimationControls(hasAnim);
      
      loadBackgroundSettings();
    });

    // بهبود VR با WebXR
    async function enterVR() {
      try {
        if (viewer.availableXRModes.includes('vr')) {
          await viewer.enterXR('vr');
        } else {
          const vrButton = viewer.shadowRoot?.querySelector('button[slot="vr-button"]');
          if (vrButton) {
            vrButton.click();
          } else {
            alert("واقعیت مجازی در این مرورگر پشتیبانی نمی‌شود!");
          }
        }
      } catch (error) {
        console.error("خطا در ورود به VR:", error);
        alert("دستگاه یا مرورگر شما از حالت واقعیت مجازی (VR) پشتیبانی نمی‌کند.");
      }
    }

    // فعال کردن تمام‌صفحه خودکار در AR
    viewer.addEventListener('ar-status', (event) => {
      if (event.detail.status === 'session-started') {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(err => {
            console.log("خطا در ورود به حالت تمام‌صفحه:", err);
          });
        }
      }
    });

    // کنترل انیمیشن
    animationToggle.addEventListener('click', () => {
      if (!hasAnimations) return;
      
      if (isPlaying) {
        viewer.pause();
        pauseIcon.style.display = 'none';
        playIcon.style.display = 'block';
        animationToggle.setAttribute('title', 'شروع انیمیشن');
        stopAnimationLoop();
      } else {
        viewer.play();
        pauseIcon.style.display = 'block';
        playIcon.style.display = 'none';
        animationToggle.setAttribute('title', 'توقف انیمیشن');
        startAnimationLoop();
      }
      isPlaying = !isPlaying;
      showControls();
    });

    // کنترل چرخش خودکار
    rotateToggle.addEventListener('click', () => {
      if (isAutoRotating) {
        viewer.autoRotate = false;
        rotateOnIcon.style.display = 'none';
        rotateOffIcon.style.display = 'block';
        rotateToggle.setAttribute('title', 'شروع چرخش خودکار');
      } else {
        viewer.autoRotate = true;
        rotateOnIcon.style.display = 'block';
        rotateOffIcon.style.display = 'none';
        rotateToggle.setAttribute('title', 'توقف چرخش خودکار');
      }
      isAutoRotating = !isAutoRotating;
      showControls();
    });

    function updateSlider() {
      if (!hasAnimations) return;
      
      const duration = viewer.duration;
      const currentTime = viewer.currentTime;
      if (duration && !isDragging) {
        slider.value = (currentTime / duration) * 100;
      }
      rafId = requestAnimationFrame(updateSlider);
    }

    function startAnimationLoop() {
      if (!hasAnimations) return;
      
      cancelAnimationFrame(rafId);
      updateSlider();
    }

    function stopAnimationLoop() {
      cancelAnimationFrame(rafId);
    }

    slider.addEventListener('pointerdown', () => {
      if (!hasAnimations) return;
      
      isDragging = true;
      wasPlayingBeforeDrag = isPlaying;
      if (isPlaying) {
        viewer.pause();
        stopAnimationLoop();
      }
      showControls();
    });

    slider.addEventListener('input', () => {
      if (!hasAnimations) return;
      
      const duration = viewer.duration;
      if (duration) {
        viewer.currentTime = (slider.value / 100) * duration;
      }
    });

    slider.addEventListener('pointerup', () => {
      if (!hasAnimations) return;
      
      if (wasPlayingBeforeDrag) {
        viewer.play();
        startAnimationLoop();
      }
      isDragging = false;
      showControls();
    });

    function toggleFullscreen() {
      const container = document.querySelector('.container');
      if (!document.fullscreenElement) {
        container.requestFullscreen().catch(err => {
          alert(`تمام‌صفحه نشد: ${err.message}`);
        });
      } else {
        document.exitFullscreen();
      }
      showControls();
    }

    function toggleHelp() {
      const overlay = document.getElementById('helpOverlay');
      overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';
      showControls();
    }

    function showControls() {
      controls.classList.remove('hidden');
      if (hasAnimations) {
        slider.classList.remove('hidden');
      }
      clearTimeout(hideTimeout);
      hideTimeout = setTimeout(() => {
        controls.classList.add('hidden');
        if (hasAnimations) {
          slider.classList.add('hidden');
        }
      }, 3000);
    }

    // توابع مربوط به تغییر پس‌زمینه
    function openBackgroundPanel() {
      document.getElementById('backgroundPanel').style.display = 'flex';
      showControls();
    }

    function closeBackgroundPanel() {
      document.getElementById('backgroundPanel').style.display = 'none';
      showControls();
    }

    function setBackgroundColor(color) {
      currentModelSettings.color = color;
      currentModelSettings.image = '';
      viewer.style.backgroundColor = color;
      viewer.style.backgroundImage = 'none';
    }

    function setCustomBackgroundColor(color) {
      setBackgroundColor(color);
    }

    function handleBackgroundImageUpload(files) {
      if (files && files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          currentModelSettings.image = e.target.result;
          currentModelSettings.color = '';
          viewer.style.backgroundImage = `url(${e.target.result})`;
          viewer.style.backgroundSize = 'cover';
        };
        reader.readAsDataURL(files[0]);
      }
    }

    function removeBackgroundImage() {
      currentModelSettings.image = '';
      currentModelSettings.color = '#ffffff';
      viewer.style.backgroundImage = '';
      viewer.style.backgroundColor = '#ffffff';
    }

    // بارگذاری تنظیمات ذخیره شده هنگام لود صفحه
    window.addEventListener('load', () => {
      loadBackgroundSettings();
      
      hideTimeout = setTimeout(() => {
        controls.classList.add('hidden');
        if (hasAnimations) {
          slider.classList.add('hidden');
        }
      }, 3000);
    });

    container.addEventListener('mousemove', showControls);
    container.addEventListener('touchmove', showControls);
    viewer.addEventListener('click', showControls);
  </script>
</body>
</html>